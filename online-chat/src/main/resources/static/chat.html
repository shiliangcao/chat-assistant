<!DOCTYPE html>
<html>
<head>
    <title>Order Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <style>
        #chat {
            display: none;
        }
        #messageList {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 5px;
        }
    </style>
</head>
<body>
<div id="login">
    <input type="text" id="orderId" placeholder="Order ID">
    <input type="text" id="identity" placeholder="Your Identity (Customer, Rider, Shop)">
    <button onclick="connect()">Join Chat</button>
</div>
<div id="chat">
    <h2>Order Chat</h2>
    <div id="messageList"></div>
    <input type="text" id="message" placeholder="Write a message...">
    <button onclick="sendMessage()">Send</button>
</div>
<script type="text/javascript">
    var stompClient = null;
    var orderId = null;
    var identity = null;

    function connect() {
        orderId = document.getElementById('orderId').value;
        identity = document.getElementById('identity').value;
        if(orderId && identity) {
            var socket = new SockJS('/orderChat');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                document.getElementById('login').style.display = 'none';
                document.getElementById('chat').style.display = 'block';
                stompClient.subscribe('/topic/orders/' + orderId, function (chatMessage) {
                    showChatMessage(JSON.parse(chatMessage.body));
                });
            });
        } else {
            alert("Order ID and Identity are required");
        }
    }

    function sendMessage() {
        var messageContent = document.getElementById('message').value;
        if(messageContent && stompClient) {
            var chatMessage = {
                orderId: orderId,
                from: identity,
                text: messageContent,
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            document.getElementById('message').value = '';
        }
    }

    function showChatMessage(message) {
        var messageElement = document.createElement('li');
        messageElement.appendChild(document.createTextNode(message.from + ": " + message.text));
        document.getElementById('messageList').appendChild(messageElement);
        document.getElementById('messageList').scrollTop = document.getElementById('messageList').scrollHeight;
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        console.log("Disconnected");
        document.getElementById('login').style.display = 'block';
        document.getElementById('chat').style.display = 'none';
    }
</script>
</body>
</html>
